<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>web/front/js.js - Ciro Santilli</title>
<meta property="og:title" content="web/front/js.js - Ciro Santilli">
<meta property="og:type" content="website">
<meta property="og:image" content="https://docs.ourbigbook.com/_raw/logo.svg">
<meta property="og:url" content="https://docs.ourbigbook.com/_file/web/front/js.js">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.1/css/all.min.css" integrity="sha512-9my9Mb2+0YO+I4PUCSwUYO7sEK21Y0STBAiFEYoWtd2VzLEZZ4QARDrZ30hdM1GlioHJ8o8cWQiy8IAb1hy/Hg==" crossorigin="anonymous" referrerpolicy="no-referrer">
<style>@import "../../../_obb/dist/ourbigbook.css";

</style>
<link rel="stylesheet" type="text/css" href="../../../_raw/main.css">
<link rel="shortcut icon" href="../../../_raw/logo.svg">
</head>
<body>
<header
<div class="brand-group">
<a href="../../../" class="brand"><img src="../../../_raw/logo.svg" alt="OurBigBook logo">OurBigBook Docs</a>
<a href="https://ourbigbook.com" class="brand"><img src="../../../_raw/logo.svg" alt="OurBigBook logo"><span class="mobile-hide">OurBigBook.com</span><span class="mobile-show">Site</span></a>
<a href="https://github.com/ourbigbook/ourbigbook"><i class="fab fa-github fa-fw icon"></i> Source code</a>
</div>
</header>
<main class="ourbigbook">
<div class="h top" id="file/web/front/js.js"><div class="notnav"><span class="file" title="This article is about a file." /><h1><a href="">web/front/js.js</a></h1></div><nav class="h-nav h-nav-toplevel"><div class="nav file"><b> <a href="../../../_dir">(root)</a> / <a href="../../../_dir/web">web</a> / <a href="../../../_dir/web/front">front</a> / <a href="../../../_raw/web/front/js.js">js.js</a></b></div></nav></div><div class="p"><b>web/front/js.js</b></div><div class="code"><div><pre><code>// Random stuff shared between front and backend.
// Has to be .js until we port backend to TypeScript..
// Maybe this should just be merged with ./config.js

const ourbigbook = require('ourbigbook')
const { titleToId } = ourbigbook

const config = require('./config')
const { convertContext } = config

const web_api = require('ourbigbook/web_api');
const { QUERY_FALSE_VAL, QUERY_TRUE_VAL } = web_api

// https://stackoverflow.com/questions/14382725/how-to-get-the-correct-ip-address-of-a-client-into-a-node-socket-io-app-hosted-o/14382990#14382990
// Works on Heroku 2021.
function getClientIp(req) {
  if (!config.isProduction &amp;&amp; config.devIp) {
    return config.devIp
  } else {
    return req.header('x-forwarded-for')
  }
}

function getCommentSlug(comment) {
  return `${comment.issue.article.slug}#${comment.issue.number}#${comment.number}`
}

function getList(req, res) {
  let ok, showUnlisted, showListed
  const showUnlistedStr = req.query['show-unlisted']
  const showListedStr = req.query['show-listed']
  if (showUnlistedStr ===  undefined) {
    showUnlisted = false
    ok = true
  } else {
    ;[showUnlisted, ok] = typecastBoolean(showUnlistedStr)
  }
  if (showListedStr === undefined) {
    showListed = true
    ok = true
  } else {
    ;[showListed, ok] = typecastBoolean(showListedStr)
  }
  if (!ok) { res.statusCode = 422 }
  return showUnlisted ? (showListed ? undefined : false) : true
}

function getOrderAndPage(req, page, opts={}) {
  const [order, orderErr, ascDesc] = getOrder(req, opts)
  const [pageNum, pageErr] = getPage(page)
  let errs = []
  if (orderErr) {
    errs.push(orderErr)
  }
  if (pageErr) {
    errs.push(pageErr)
  }
  return {
    ascDesc,
    err: errs.length ? errs : undefined,
    order,
    page: pageNum,
  }
}

/** GET param -&gt; DB order map. undefined means both are the same. */
const ALLOWED_SORTS_DEFAULT = {
  created: 'createdAt',
  updated: 'updatedAt',
}

/** By default we order by DESC because it works well with createdAt/updatedAt and score.
 * But for these things, notably alphabetical listings, we want to sort alphabetically instead by default. */
const SORT_WITH_DEFAULT_ASC = new Set([
  'nestedSetIndex',
  'slug',
  'topicId',
  'username',
])
const ASC_GET_SUFFIX  = '-asc'
const DESC_GET_SUFFIX  = '-desc'

function getOrder(req, opts={}) {
  let sort = req.query.sort
  let ascDesc
  let {
    allowedSorts,
    allowedSortsExtra,
    defaultOrder: default_,
  } = opts
  if (allowedSorts === undefined) {
    allowedSorts = ALLOWED_SORTS_DEFAULT
  }
  if (allowedSortsExtra === undefined) {
    allowedSortsExtra = {}
  }
  if (default_ === undefined) {
    default_ = 'createdAt'
  }
  let ret, err
  if (sort) {
    if (sort.endsWith(ASC_GET_SUFFIX)) {
      ascDesc = 'asc'
      sort = sort.substring(0, sort.length - ASC_GET_SUFFIX.length)
    } else if (sort.endsWith(DESC_GET_SUFFIX)) {
      ascDesc = 'desc'
      sort = sort.substring(0, sort.length - DESC_GET_SUFFIX.length)
    }
    const allowedSortsEff = Object.assign(
      {},
      allowedSorts,
      allowedSortsExtra
    )
    if (sort in allowedSortsEff) {
      const order = allowedSortsEff[sort]
      if (order) {
        ret = order
      } else {
        ret = sort
      }
    } else {
      if (default_ in allowedSortsEff) {
        ret = default_
      } else {
        // Return one arbitrary sort.
        ret = Object.values(allowedSortsEff)[0]
      }
      err = `Invalid sort value: '${sort}'`
    }
  } else {
    ret = default_
  }
  return [
    ret, 
    err,
    (ascDesc ? ascDesc : SORT_WITH_DEFAULT_ASC.has(ret) ? 'ASC' : 'DESC') + ' NULLS LAST'
  ]
}

/**
 * @param {string|string[]} page - 1-based.
 * @returns {[number, string|undefined]} 0-based return, error string if any.
 */
function getPage(page='1') {
  const pageString = typeof page === 'string' ? page : page[0]
  const [pageNum, ok] = typecastInteger(page)
  if (ok) {
    if (pageNum &lt;= 0) {
      return [0, 'The page must be positive']
    } else {
      return [pageNum - 1,]
    }
  } else {
    return [0, 'Invalid page number']
  }
}

function hasReachedMaxItemCount(loggedInUser, itemCount, itemType) {
  if (!loggedInUser.admin &amp;&amp; itemCount &gt;= loggedInUser.maxArticles) {
    return `You have reached your maximum number of ${itemType}: ${loggedInUser.maxArticles}. ` +
           `Please ask an admin to raise it for you: ${config.contactUrl}`
  }
}

function typecastBoolean(s) {
  let b
  let ok = true
  if (s === QUERY_TRUE_VAL) {
    b = true
  } else if (s === QUERY_FALSE_VAL) {
    b = false
  } else {
    ok = false
  }
  return [b, ok]
}

/**
 * Typecast string to integer. Typically used to typecast
 * URL GET parameters to types with error checking. This is unlike
 * JSON bodies which are clearly typed already.
 * 
 * @param {string} s
 * @returns {[number, boolean]}
 */
function typecastInteger(s) {
  const i = Number(s)
  let ok = s !== '' &amp;&amp; Number.isInteger(i)
  return [i, ok]
}

function isNonNegativeInteger(i) {
  return Number.isInteger(i) &amp;&amp; i &gt;= 0
}

function isPositiveInteger(i) {
  return Number.isInteger(i) &amp;&amp; i &gt; 0
}

// Elements either match cb, or is an array where each type matches cb.
function isTypeOrArrayOf(cb) {
  return (a) =&gt; {
    if (cb(a)) return true
    return isArrayOf(cb)(a)
  }
}

function ipBlockedForSignupMessage(ip, ipBlockPrefix) {
  return `You cannot sign up from your current IP ${ip} because ` +
  `the IP prefix ${ipBlockPrefix} was blocked by admins due to abuse`
}

function isArrayOf(cb) {
  return (a) =&gt; {
    if (!(a instanceof Array)) {
      return false
    }
    for (const elem of a) {
      if (!cb(elem)) {
        return false
      }
    }
    return true
  }
}

function isBoolean(tf) {
  return typeof tf === 'boolean'
}

/** Is it an email? And not a username. */
function isEmail(s) {
  return s.indexOf('@') !== -1
}

function isSmallerOrEqualTo(max) {
  return (n) =&gt; n &lt;= max
}

function isLengthSmallerOrEqualTo(max) {
  return (s) =&gt; s.length &lt;= max
}

function isString(s) {
  return typeof s === 'string'
}

function isTruthy(s) {
  return !!s
}

// ID, slug and topic conversions

function slugToTopic(slug) {
  return slug.split(ourbigbook.Macro.HEADER_SCOPE_SEPARATOR).slice(1).join(ourbigbook.Macro.HEADER_SCOPE_SEPARATOR)
}

function idToSlug(id) {
  return id.slice(ourbigbook.AT_MENTION_CHAR.length)
}

function idToTopic(id) {
  return slugToTopic(idToSlug(id))
}

function uidTopicIdToId(uid, topicId) {
  return ourbigbook.AT_MENTION_CHAR + uidTopicIdToSlug(uid, topicId)
}

function uidTopicIdToSlug(uid, topicId) {
  let ret =  `${uid}`
  if (topicId) {
    ret = `${ret}${ourbigbook.Macro.HEADER_SCOPE_SEPARATOR}${topicId}`
  }
  return ret
}

function slugToId(slug) {
  return ourbigbook.AT_MENTION_CHAR + slug
}

function querySearchToTopicId(search) {
  return search === undefined ? undefined : titleToId(search, undefined, convertContext)
}

module.exports = {
  AUTH_COOKIE_NAME: 'auth',
  getClientIp,
  getCommentSlug,
  getList,
  getOrder,
  getOrderAndPage,
  getPage,
  hasReachedMaxItemCount,
  idToSlug,
  idToTopic,
  ipBlockedForSignupMessage,
  isArrayOf,
  isBoolean,
  isEmail,
  isLengthSmallerOrEqualTo,
  isNonNegativeInteger,
  isPositiveInteger,
  isSmallerOrEqualTo,
  isString,
  isTruthy,
  isTypeOrArrayOf,
  querySearchToTopicId,
  slugToId,
  slugToTopic,
  typecastBoolean,
  typecastInteger,
  uidTopicIdToId,
  uidTopicIdToSlug,
}
</code></pre></div></div></main>
<footer>
<div>License: <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> unless noted</div>
<div><a href="../../../_dir">Website source code</a></div>
</footer>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2XSEK2ND00"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-2XSEK2ND00');
</script>
<script src="https://giscus.app/client.js"
        data-repo="ourbigbook/ourbigbook"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyMTEyOTA2NzA="
        data-category="giscus"
        data-category-id="DIC_kwDODJgKLs4CZ61S"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark_high_contrast"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
<script>
window.ourbigbook_split_headers = false;
window.ourbigbook_html_x_extension = false;
window.ourbigbook_redirect_prefix = "";
</script>
<script src="../../../_obb/dist/ourbigbook_runtime.js"></script><script>ourbigbook_runtime.ourbigbook_runtime()</script></body>
</html>
