<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>Conversion process overview - Ciro Santilli</title>
<meta property="og:title" content="Conversion process overview - Ciro Santilli">
<meta property="og:type" content="website">
<meta property="og:image" content="https://docs.ourbigbook.com/_raw/logo.svg">
<meta property="og:url" content="https://docs.ourbigbook.com/conversion-process-overview">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.1/css/all.min.css" integrity="sha512-9my9Mb2+0YO+I4PUCSwUYO7sEK21Y0STBAiFEYoWtd2VzLEZZ4QARDrZ30hdM1GlioHJ8o8cWQiy8IAb1hy/Hg==" crossorigin="anonymous" referrerpolicy="no-referrer">
<style>@import "_obb/dist/ourbigbook.css";

</style>
<link rel="stylesheet" type="text/css" href="_raw/main.css">
<link rel="shortcut icon" href="_raw/logo.svg">
</head>
<body>
<header
<div class="brand-group">
<a href="." class="brand"><img src="_raw/logo.svg" alt="OurBigBook logo">OurBigBook Docs</a>
<a href="https://ourbigbook.com" class="brand"><img src="_raw/logo.svg" alt="OurBigBook logo"><span class="mobile-hide">OurBigBook.com</span><span class="mobile-show">Site</span></a>
<a href="https://github.com/ourbigbook/ourbigbook"><i class="fab fa-github fa-fw icon"></i> Source code</a>
</div>
</header>
<main class="ourbigbook">
<div class="h top" id="conversion-process-overview"><div class="notnav"><h1><a href="">Conversion process overview</a></h1></div><nav class="h-nav h-nav-toplevel"><div class="nav ancestors"><a href="."><span title="Home" class="fa-solid-900 icon">ÔÄï</span> Home</a><a href=".#developing-ourbigbook"> Developing OurBigBook</a></div><div class="nav"><a href="#_toc" class="toc"></a><a class="nosplit" href=".#conversion-process-overview"></a><span class="metrics"><span class="wcntr"> Words: 1k</span><span class="dcnt"> Articles: 4</span></span></div></nav></div><div class="p" id="_5285">A conversion follows the following steps done for each file to be converted:<div class="list"><ul id="_5286"><li id="_5287">tokenizer. Reads the input and converts it to a linear list of tokens.</li><li id="_5288">parser. Reads the list of tokens and converts it into an <a href=".#abstract-syntax-tree">abstract syntax tree</a>. Parse can be called multiple times recursively when doing things like.</li><li id="_5289"><div class="p" id="_5290">ast post process pass 1.</div><div class="p" id="_5291">An ast post process pass takes abstract syntax tree that comes out of a previous step, e.g. the original parser output, and modifies the it tree to achieve various different functionalities.</div><div class="p" id="_5292">We may need iterate the tree multiple times to achieve all desired effects, at the time of writing it was done twice. Each iteration is called pass.</div><div class="p" id="_5293">You can view snapshots of the tree after each pass with the <a href=".#log"><code>--log</code></a> option:<div class="code" id="_5294"><div><pre><code>ourbigbook --log=ast-pp-simple input.bigb</code></pre></div></div></div><div class="p" id="_5295">This first pass basically does few but very wide reacing operations that will determine what data we will have to fetch from the database during the followng DB queries step.</div><div class="p" id="_5296">It might also do some operations that are required for pass 2 but that don't necessarily fetch data, not sure anymore.</div><div class="p" id="_5297">E.g. this is where the following functionality are implemented:<div class="list"><ul id="_5298"><li id="_5299"><a href=".#h-synonym-argument">synonym</a> and <a href=".#h-scope-argument">scope</a></li><li id="_5300"><a href=".#ourbigbookexample"><code>\OurBigBookExample</code></a> and <a href=".#embed-includes"><code>--embed-includes</code></a>: they are stitched into the main AST</li></ul></div></div></li><li id="_5301">ast post process pass 2: we now do every other post process operation that was not done in pass 1, e.g.:<div class="list"><ul id="_5302"><li id="_5303"><a href=".#macro-shorthand-syntax">shorthand</a> paragraphs, lists and tables</li></ul></div></li><li id="_5304">ast post process pass 3: this does some minimal tree hierarchy linking between parents and children. TODO could it be merged into 2? Feels likely</li><li id="_5305"><div class="p" id="_5306">render, which converts our AST tree into a output string. This is run once for the toplevel, and once for every header of the document if <a href=".#split-headers"><code>-S</code>, <code>--split-headers</code></a> are enabled. We need to do this because header renders are different from their toplevel counterparts, e.g. their first paragraph has id <code>p-1</code> and not <code>p-283</code>. All of those renders are done from the same parsed tree however, parsing happens only once.</div><div class="p" id="_5307">This step is skipped when using the <a href=".#no-render"><code>--no-render</code></a> option, or during <a href=".#id-extraction">ID extraction</a>.</div><div class="p" id="_5308">TODO it is intended that it should not be possible for there to be rendering errors once the previous steps have concluded successfully. This is currently not the case for at least one known scenario however: <a href=".#internal-link">internal links</a> that are not defined.</div><div class="p" id="_5309">Sub-steps include:<div class="list"><ul id="_5310"><li id="_5311"><div class="p" id="_5312">DB queries: this is the first thing we do during the rendering step.</div><div class="p" id="_5313">Every single database query must be done at this point, in one go.</div><div class="p" id="_5314">Database queries are only done while rendering, never when parsing. The database is nothing but a cache for source file state, and this separation means that we can always cache input source state into the database during parsing without relying on the database itself, and thus preventing any circular dependencies from parsing to parsing.<a href="https://cirosantilli.com/china-dictatorship/reddit"><sup class="ref">[ref]</sup></a></div><div class="p" id="_5315">Keeping all queries together is fundamental for performance reasons, especially of <a href=".#browser-editor-with-preview">browser editor with preview</a> in the <a href=".#ourbigbook-web">OurBigBook Web</a>: imagine doing 100 scattered server queries:<div class="code" id="_5316"><div><pre><code>SELECT * from Ids WHERE id = '0'
SELECT * from Ids WHERE id = '1'
...
SELECT * from Ids WHERE id = '100'</code></pre></div></div>vs grouping them together:<div class="code" id="_5317"><div><pre><code>SELECT * from Ids WHERE id IN ('0', '1', ..., '100')</code></pre></div></div>It also has the benefit of allowing us to remove <code>async</code>/<code>await</code> from almost every single function in the code, which considerably slows down the CPU-bound execution path.</div><div class="p" id="_5318">As an added bonus, it also allows us to clearly see the impact of database queries when using <a href=".#log-perf"><code>--log perf</code></a>.</div><div class="p" id="_5319">We call this joining up of small queries into big ones "query bundling".</div></li></ul></div></div></li><li id="_5320"><div class="p" id="_5321">at the every end of the conversion, we then save the database changes calculated during parsing and post processing back to the DB so that the conversion of other files will pick them up.</div><div class="p" id="_5322">Just like for the SELECT, we do a single large INSERT/UPDATE query per database to reduce the round trips.</div></li></ul></div></div><div class="p" id="_5323">Conversion of a directory with multiple input files works as follows:<div class="list"><ul id="_5324"><li id="_5325">do one <a href=".#id-extraction">ID extraction</a> pass without render</li><li id="_5326">do a global database check/fixup for all files that have been parsed which checks in one go for:<div class="list"><ul id="_5327"><li id="_5328"><div class="p" id="_5329">check that all <a href=".#internal-link">internal link</a> targets exist.</div><div class="p" id="_5330">When using the <a href=".#x-magic-argument"><code>\x</code> <code>magic</code> argument</a>:<div class="list"><ul id="_5331"><li id="_5332">only one of the plural/singular needs to exist</li><li id="_5333">we then decide which one to use and delete the other one. Both are initially placed in the database during the <a href=".#id-extraction">ID extraction</a> phase.</li></ul></div></div></li><li id="_5334">duplicate IDs</li><li id="_5335">references from one non-header title to another non-header title as mentioned at <a href=".#x-within-title-restrictions"><code>\x</code> within <code>title</code> restrictions</a></li></ul></div>Ideally, failure of any of the above checks should lead to the database not being updated with new values, but that is not the case as of writing.</li><li id="_5336">do one conversion pass with render. To speed up conversion, we might at some point start storing a parsed JSON after the first conversion pass, and then just deserialize it and convert the deserialized output directly without re-parsing.</li></ul></div>The two pass approach is required to resolve <a href=".#internal-link">internal links</a></div><div class="toc-container" id="_toc"><ul><li class="has-child toplevel"><div class="title-div"><div class="arrow"><div></div></div><span class="not-arrow"><a class="title toc" href="#_toc"> Table of contents</a><input class="search" placeholder="üîç Search. Shortcut: / (slash)"><span class="hover-metadata"><span class="metrics"><span class="wcntr"> 1k</span><span class="dcnt"> 4</span></span></span></span></div><ul><li><div id="_toc/id-extraction"><div class="arrow"><div></div></div><span class="not-arrow"><a href=".#id-extraction">ID extraction</a><span class="hover-metadata"><a href="#_toc" class="u"> Conversion process overview</a><span class="metrics"><span class="wcntr"> 21</span></span></span></span></div></li><li><div id="_toc/abstract-syntax-tree"><div class="arrow"><div></div></div><span class="not-arrow"><a href=".#abstract-syntax-tree">Abstract syntax tree</a><span class="hover-metadata"><a href="#_toc" class="u"> Conversion process overview</a><span class="metrics"><span class="wcntr"> 265</span></span></span></span></div></li><li class="has-child"><div id="_toc/autogenerated-tests"><div class="arrow"><div></div></div><span class="not-arrow"><a href=".#autogenerated-tests">Autogenerated tests</a><span class="hover-metadata"><a href="#_toc" class="u"> Conversion process overview</a><span class="metrics"><span class="wcntr"> 59</span><span class="dcnt"> 1</span></span></span></span></div><ul><li><div id="_toc/generate-paragraphs"><div class="arrow"><div></div></div><span class="not-arrow"><a href=".#generate-paragraphs">generate-paragraphs</a><span class="hover-metadata"><a href="#_toc/autogenerated-tests" class="u"> Autogenerated tests</a><span class="metrics"><span class="wcntr"> 15</span></span></span></span></div></li></ul></li></ul></li></ul></div><h2 id="_ancestors"><a href="#_ancestors"><span class="fa-solid-900 icon">ÔÅ¢</span> Ancestors <span class="meta">(2)</span></a></h2><div class="list"><ol><li><a href=".#developing-ourbigbook">Developing OurBigBook</a></li><li><a href="."><span title="Home" class="fa-solid-900 icon">ÔÄï</span> Home</a></li></ol></div><h2 id="_incoming-links"><a href="#_incoming-links"><span title="Incoming links" class="fa-solid-900 icon">ÔÅ†</span> Incoming links <span class="meta">(3)</span></a></h2><div class="list"><ul><li><a href=".#force-render">-<code>F</code>, <code>--force-render</code></a></li><li><a href=".#log"><code>--log</code></a></li><li><a href=".#log-perf"><code>--log perf</code></a></li></ul></div></main>
<footer>
<div>License: <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> unless noted</div>
<div><a href="_dir">Website source code</a></div>
<div>Source code for this page: <a href="_file/index.bigb">index.bigb</a></div>
</footer>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2XSEK2ND00"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-2XSEK2ND00');
</script>
<script src="https://giscus.app/client.js"
        data-repo="ourbigbook/ourbigbook"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyMTEyOTA2NzA="
        data-category="giscus"
        data-category-id="DIC_kwDODJgKLs4CZ61S"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark_high_contrast"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
<script>
window.ourbigbook_split_headers = true;
window.ourbigbook_html_x_extension = false;
window.ourbigbook_redirect_prefix = "";
</script>
<script src="_obb/dist/ourbigbook_runtime.js"></script><script>ourbigbook_runtime.ourbigbook_runtime()</script></body>
</html>
